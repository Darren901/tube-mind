# 每日額度限制系統實作總結

## 實作日期
2026-01-30

## 目的
防止雲端部署後遭遇惡意使用者濫用，導致 Google Gemini API 費用失控。

## 雙重限流機制

### 1. 每日額度限制（主要成本控制）
- **限制**: 每位使用者每 24 小時（滾動）最多生成 10 個摘要
- **計算方式**: 查詢過去 24 小時內建立的 Summary 數量
- **重置機制**: 滾動 24 小時（從最早的摘要建立時間計算）
- **實作位置**: `lib/quota/dailyLimit.ts`

### 2. 待處理任務上限（系統資源保護）
- **限制**: 每位使用者最多同時擁有 25 個待處理任務
- **計算方式**: 查詢 BullMQ 的 waiting、active、delayed 任務數
- **目的**: 防止 Redis 記憶體耗盡與 Worker 過載
- **實作位置**: `lib/queue/summaryQueue.ts`

## 檔案變更清單

### 新增檔案
1. `lib/quota/dailyLimit.ts` - 每日額度檢查邏輯
2. `app/api/quota/route.ts` - 查詢額度狀態 API
3. `test/lib/quota/dailyLimit.test.ts` - 單元測試（5 個測試案例，100% 通過）

### 修改檔案
1. `lib/queue/summaryQueue.ts` - 加入 `enforceQuota()` 檢查
2. `app/api/summaries/route.ts` - 錯誤處理（返回 429 狀態碼）
3. `app/api/summaries/batch/route.ts` - 批次操作錯誤處理
4. `app/api/summaries/[id]/retry/route.ts` - 重試時檢查額度
5. `app/api/channels/[id]/refresh/route.ts` - 頻道更新時檢查額度
6. `README.md` - 新增「雙重限流機制」章節

## API 端點

### GET /api/quota
查詢當前使用者的額度狀態

**回應範例**:
```json
{
  "used": 5,
  "limit": 10,
  "remaining": 5,
  "resetAt": "2026-01-31T03:15:00.000Z"
}
```

## 錯誤訊息

### 超過每日額度
```
已達到每日摘要生成上限（10 個/24 小時）。將在約 3 小時後重置。
```

### 超過待處理任務上限
```
已達到待處理任務上限（25 個）。請等待現有任務完成後再試。
```

## 技術細節

### 為何使用「滾動 24 小時」而非「每日重置」？
- **公平性**: 避免使用者在 23:59 和 00:01 各用一次額度
- **簡化實作**: 不需維護重置時間戳記，直接查詢資料庫即可
- **使用者體驗**: 隨時都有可能恢復額度，而非必須等到隔天

### 為何查詢資料庫而非快取在 User 表？
- **簡化實作**: 不需要 migration，立即可用
- **準確性**: 直接統計 Summary 數量，不會有快取不同步問題
- **可擴展性**: 未來若需改為「週額度」或「月額度」，只需修改時間範圍

### 效能考量
- 查詢條件有索引支援（`userId` + `createdAt`）
- 單次查詢僅需兩個 SQL（count + findFirst）
- 若未來使用者數量增加導致效能問題，可考慮加入 Redis 快取

## 未來優化方向

### 方案 A: 加入 Redis 快取
- 在 User 表加入 `dailyQuotaUsed` 和 `quotaResetAt` 欄位
- 使用 Redis 快取額度狀態，定期同步至資料庫
- 優點：查詢更快
- 缺點：需要處理快取失效與同步問題

### 方案 B: 分級會員制
- 免費用戶：10 個/天
- 基礎會員：50 個/天
- 專業會員：無限制
- 需要加入付費機制與會員管理系統

### 方案 C: 動態額度調整
- 根據系統負載動態調整額度
- 離峰時段提高額度，尖峰時段降低
- 需要監控系統與動態配置機制

## 測試覆蓋

### 單元測試 (`test/lib/quota/dailyLimit.test.ts`)
- ✅ 未達上限時允許使用
- ✅ 達到上限時拒絕使用
- ✅ 正確計算重置時間
- ✅ enforceQuota 在可用時不拋錯
- ✅ enforceQuota 在超限時拋出明確錯誤訊息

### 整合測試
- 需要手動測試 API 端點回應
- 建議在部署前執行完整的端到端測試

## 部署注意事項

1. **環境變數**: 無需額外環境變數
2. **資料庫**: 現有 Schema 即可支援，無需 migration
3. **監控**: 建議加入額度使用監控（例如：每日平均使用量、超限次數）
4. **調整額度**: 修改 `DAILY_SUMMARY_LIMIT` 常數即可（目前為 10）

## 成本估算

假設每個摘要平均消耗：
- 字幕長度：5,000 tokens
- AI 回應：2,000 tokens
- 總計：7,000 tokens/摘要

**Gemini 2.5 Flash 定價（2026-01-30）**:
- Input: $0.075 / 1M tokens
- Output: $0.30 / 1M tokens

**每位使用者每日成本**:
- Input: (5,000 tokens × 10) × $0.075 / 1M = $0.00375
- Output: (2,000 tokens × 10) × $0.30 / 1M = $0.006
- **總計**: $0.00975/使用者/天

**100 位活躍使用者每月成本**:
- $0.00975 × 100 × 30 = **$29.25/月**

✅ 在可控範圍內！
